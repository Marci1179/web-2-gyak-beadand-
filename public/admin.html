<!DOCTYPE html>
<html lang="hu">

<head>
  <meta charset="UTF-8">
  <title>Admin – Felhasználók kezelése</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .table-dark input,
    .table-dark select {
      background-color: #212529;
      color: #f8f9fa;
      border: 1px solid #495057;
    }
  </style>
</head>

<body class="bg-dark text-light">

  <nav class="navbar navbar-expand-lg navbar-dark bg-black">
  <div class="container d-flex justify-content-center">

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse justify-content-center" id="mainNav">
      <ul class="navbar-nav">

        <li class="nav-item mx-2">
          <a class="nav-link" href="/app029/">Főoldal menü</a>
        </li>
        <li class="nav-item mx-2">
          <a class="nav-link" href="/app029/adatbazis">Adatbázis menü</a>
        </li>
        <li class="nav-item mx-2">
          <a class="nav-link" href="/app029/kapcsolat">Kapcsolat menü</a>
        </li>
        <li class="nav-item mx-2">
          <a class="nav-link" href="/app029/crud">CRUD menü</a>
        </li>

        <!-- csak bejelentkezve -->
        <li class="nav-item mx-2 d-none" id="nav-uzenetek">
          <a class="nav-link" href="/app029/uzenetek">Üzenetek menü</a>
        </li>

        <!-- csak admin -->
        <li class="nav-item mx-2 d-none" id="nav-admin">
          <a class="nav-link" href="/app029/admin">Admin menü</a>
        </li>

        <!-- vendégek -->
        <li class="nav-item mx-2" id="nav-login">
          <a class="nav-link" href="/app029/login">Bejelentkezés</a>
        </li>
        <li class="nav-item mx-2" id="nav-register">
          <a class="nav-link" href="/app029/register">Regisztráció</a>
        </li>

        <!-- csak bejelentkezve -->
        <li class="nav-item mx-2 d-none" id="nav-logout">
          <a class="nav-link text-warning" href="/app029/logout">Kijelentkezés</a>
        </li>

      </ul>
    </div>

  </div>
</nav>


  <main class="container py-5">
    <h1 class="mb-4 text-danger fw-bold text-center">Admin felület – felhasználók kezelése</h1>

    <div class="row mb-4">
      <div class="col-md-4 mb-3">
        <div class="card bg-secondary border-0 shadow-sm">
          <div class="card-body">
            <h2 class="h6 text-uppercase text-muted mb-2">Összes felhasználó</h2>
            <p class="h4 mb-0 text-white" id="stat-total">0</p>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="card bg-secondary border-0 shadow-sm">
          <div class="card-body">
            <h2 class="h6 text-uppercase text-muted mb-2">Adminok</h2>
            <p class="h4 mb-0 text-white" id="stat-admins">0</p>
          </div>
        </div>
      </div>
    </div>

    <div class="card bg-secondary border-0 shadow">
      <div class="card-body">
        <h2 class="h5 mb-3 text-white">Felhasználók</h2>
        <div class="table-responsive">
          <table class="table table-dark table-striped align-middle mb-0" id="usersTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Név</th>
                <th>Email</th>
                <th>Szerep</th>
                <th>Regisztrált</th>
                <th>Műveletek</th>
              </tr>
            </thead>
            <tbody>
              <!-- JS tölti fel -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    async function betoltUsers() {
      const res = await fetch('/app029/api/users');
      if (!res.ok) {
        alert('Hiba a felhasználók lekérésekor.');
        return;
      }
      const users = await res.json();

      const tbody = document.querySelector('#usersTable tbody');
      tbody.innerHTML = '';

      let total = 0;
      let admins = 0;

      users.forEach(u => {
        total++;
        if (u.role === 'admin') admins++;

        const tr = document.createElement('tr');
        tr.dataset.id = u.id;

        tr.innerHTML = `
          <td>${u.id}</td>
          <td>
            <input class="form-control form-control-sm" value="${u.name || ''}">
          </td>
          <td>
            <input class="form-control form-control-sm" value="${u.email || ''}">
          </td>
          <td>
            <select class="form-select form-select-sm">
              <option value="user" ${u.role === 'user' ? 'selected' : ''}>user</option>
              <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>admin</option>
            </select>
          </td>
          <td>${u.created_at ? new Date(u.created_at).toLocaleString('hu-HU') : ''}</td>
          <td>
            <button class="btn btn-sm btn-warning me-2 btn-save">Szerkesztés</button>
            <button class="btn btn-sm btn-danger btn-delete">Törlés</button>
          </td>
        `;

        tbody.appendChild(tr);
      });

      document.getElementById('stat-total').innerText = total;
      document.getElementById('stat-admins').innerText = admins;
    }

    document.addEventListener('click', async (e) => {
      const saveBtn = e.target.closest('.btn-save');
      const delBtn = e.target.closest('.btn-delete');

      if (saveBtn) {
        const tr = saveBtn.closest('tr');
        const id = tr.dataset.id;
        const inputs = tr.querySelectorAll('input, select');
        const [nameInput, emailInput, roleSelect] = inputs;

        const payload = {
          name: nameInput.value,
          email: emailInput.value,
          role: roleSelect.value
        };

        const res = await fetch('/app029/api/users/' + id, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          alert('Hiba a mentéskor.');
        } else {
          alert('Sikeres mentés.');
          betoltUsers();
        }
      }

      if (delBtn) {
        const tr = delBtn.closest('tr');
        const id = tr.dataset.id;

        if (!confirm('Biztosan törlöd ezt a felhasználót?')) return;

        const res = await fetch('/app029/api/users/' + id, {
          method: 'DELETE'
        });

        if (!res.ok) {
          alert('Hiba a törléskor.');
        } else {
          tr.remove();
          betoltUsers();
        }
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      betoltUsers();
    });

    async function frissitNav() {
    try {
      const res = await fetch('/app029/api/auth/me');
      const data = await res.json();

      const show = id => document.getElementById(id)?.classList.remove('d-none');
      const hide = id => document.getElementById(id)?.classList.add('d-none');

      // Alap: vendég
      show('nav-login');
      show('nav-register');
      hide('nav-logout');
      hide('nav-uzenetek');
      hide('nav-admin');

      if (data.loggedIn) {
        // bejelentkezve
        hide('nav-login');
        hide('nav-register');
        show('nav-logout');
        show('nav-uzenetek');

        if (data.user.role === 'admin') {
          show('nav-admin');
        }
      }
    } catch (e) {
      console.error('Nav frissítés hiba:', e);
    }
  }

  document.addEventListener('DOMContentLoaded', frissitNav);
  </script>

</body>

</html>
