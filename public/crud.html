<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset="UTF-8">
    <title>F1 Adatbázis – CRUD menü</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #212529;
            color: #fff;
        }

        /* Táblázat szövegszín */
        table td,
        table th {
            color: #fff !important;
        }

        /* Kártyák és fejlécek szövegszín */
        .card,
        .card-header,
        .card-body {
            color: #fff;
        }

        .card-header h2,
        .card-header .h4 {
            color: #fff;
        }

        /* Űrlap label-ek */
        .form-label {
            color: #fff;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
        }
    </style>
</head>

<body class="bg-dark text-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-black">
  <div class="container d-flex justify-content-center">

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse justify-content-center" id="mainNav">
      <ul class="navbar-nav">

        <!-- Mindig látszik -->
        <li class="nav-item mx-2">
          <a class="nav-link" href="/app029/">Főoldal menü</a>
        </li>
        <li class="nav-item mx-2">
          <a class="nav-link" href="/app029/adatbazis">Adatbázis menü</a>
        </li>
        <li class="nav-item mx-2">
          <a class="nav-link" href="/app029/kapcsolat">Kapcsolat menü</a>
        </li>
        <li class="nav-item mx-2">
          <a class="nav-link" href="/app029/crud">CRUD menü</a>
        </li>

        <!-- Üzenetek: csak bejelentkezve -->
        <li class="nav-item mx-2 d-none" id="nav-uzenetek">
          <a class="nav-link" href="/app029/uzenetek">Üzenetek menü</a>
        </li>

        <!-- Admin: csak admin -->
        <li class="nav-item mx-2 d-none" id="nav-admin">
          <a class="nav-link" href="/app029/admin">Admin menü</a>
        </li>

        <!-- Auth gombok -->
        <li class="nav-item mx-2" id="nav-login">
          <a class="nav-link" href="/app029/login">Bejelentkezés</a>
        </li>
        <li class="nav-item mx-2" id="nav-register">
          <a class="nav-link" href="/app029/register">Regisztráció</a>
        </li>
        <li class="nav-item mx-2 d-none" id="nav-logout">
          <a class="nav-link text-warning" href="/app029/logout">Kijelentkezés</a>
        </li>

      </ul>
    </div>

  </div>
</nav>


<header class="py-5 text-center">
    <div class="container">
        <h1 class="display-4 fw-bold">CRUD menü – Pilóták</h1>
        <p class="lead mt-3">
            Teljes CRUD funkcionalitás az <strong>F1 pilóták</strong> táblához (Create, Read, Update, Delete).
        </p>
    </div>
</header>

<main class="container pb-5">

    <!-- ŰRLAP: Új / módosítás -->
    <section class="mb-5">
        <div class="card bg-secondary bg-opacity-25 border-light">
            <div class="card-header">
                <h2 class="h4 mb-0" id="formTitle">Új pilóta felvitele</h2>
            </div>
            <div class="card-body">
                <form id="pilotForm" class="row g-3">
                    <!-- rejtett mező az id-nek szerkesztéskor -->
                    <input type="hidden" id="pilotId">

                    <div class="col-md-2">
                        <label for="legacyId" class="form-label">Legacy ID</label>
                        <input type="number" class="form-control" id="legacyId" placeholder="pl. 101">
                    </div>

                    <div class="col-md-4">
                        <label for="name" class="form-label">Név</label>
                        <input type="text" class="form-control" id="name" required>
                    </div>

                    <div class="col-md-2">
                        <label for="gender" class="form-label">Nem</label>
                        <select id="gender" class="form-select" required>
                            <option value="">Válasszon...</option>
                            <option value="F">F</option>
                            <option value="N">N</option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label for="birthDate" class="form-label">Születési dátum</label>
                        <input type="date" class="form-control" id="birthDate">
                    </div>

                    <div class="col-md-2">
                        <label for="nationality" class="form-label">Állampolgárság</label>
                        <input type="text" class="form-control" id="nationality" required>
                    </div>

                    <div class="col-12 d-flex align-items-center gap-2 mt-3">
                        <button type="submit" class="btn btn-success" id="saveButton">Új pilóta mentése</button>
                        <button type="button" class="btn btn-outline-light d-none" id="cancelEditButton">Mégse</button>
                        <span class="ms-auto small" id="formMessage"></span>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- TÁBLA: Pilóták listázása -->
    <section>
        <div class="card bg-secondary bg-opacity-25 border-light">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="h4 mb-0">Pilóták listája</h2>
                <span class="small" id="tableInfo"></span>
            </div>
            <div class="card-body table-responsive">
                <table class="table table-dark table-striped table-hover align-middle mb-0" id="pilotsTable">
                    <thead>
                        <tr>
                            <th scope="col" data-column="id" data-label="ID" class="sortable">ID</th>
                            <th scope="col" data-column="legacy_id" data-label="Legacy ID" class="sortable">Legacy ID</th>
                            <th scope="col" data-column="name" data-label="Név" class="sortable">Név</th>
                            <th scope="col" data-column="gender" data-label="Nem" class="sortable">Nem</th>
                            <th scope="col" data-column="birth_date" data-label="Születési dátum" class="sortable">Születési dátum</th>
                            <th scope="col" data-column="nationality" data-label="Állampolgárság" class="sortable">Állampolgárság</th>
                            <th scope="col">Műveletek</th>
                        </tr>
                    </thead>
                    <tbody id="pilotsTbody">
                        <!-- JavaScript tölti be -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ---- FRONTEND LOGIKA PILÓTÁK CRUD-HOZ ----

const API_BASE = '/app029/api/pilots';

let pilots = [];
let sortColumn = 'id';
let sortDirection = 'asc'; // 'asc' vagy 'desc'
let editingId = null;

// dátum formázása YYYY-MM-DD-re (táblához és inputhoz is jó)
function formatDate(d) {
    if (!d) return '';
    // ha Date objektum
    if (d instanceof Date) {
        return d.toISOString().split('T')[0];
    }
    // ha string és legalább 10 hosszú, az első 10 karakter elég (YYYY-MM-DD...)
    if (typeof d === 'string' && d.length >= 10) {
        return d.slice(0, 10);
    }
    // egyébként Date-ként
    const date = new Date(d);
    if (isNaN(date)) return '';
    return date.toISOString().split('T')[0];
}

// Segéd: üzenet kiírása az űrlap alatt
function setFormMessage(text, isError = false) {
    const span = document.getElementById('formMessage');
    span.textContent = text;
    span.className = 'small ' + (isError ? 'text-danger' : 'text-success');
}

// Segéd: infó a táblázat fölé
function setTableInfo(text) {
    document.getElementById('tableInfo').textContent = text;
}

// Pilóták betöltése (READ)
async function loadPilots() {
    try {
        const res = await fetch(API_BASE);
        if (!res.ok) {
            throw new Error('Hibás válasz a szervertől.');
        }
        pilots = await res.json();
        renderTable();
        setTableInfo(`Összesen ${pilots.length} pilóta található az adatbázisban.`);
    } catch (err) {
        console.error(err);
        setTableInfo('Hiba a pilóták betöltésekor.');
    }
}

// Táblázat renderelése + rendezés
function renderTable() {
    const tbody = document.getElementById('pilotsTbody');
    tbody.innerHTML = '';

    const sorted = [...pilots].sort((a, b) => {
        const col = sortColumn;
        let av = a[col];
        let bv = b[col];

        // null/undefined kezelése
        if (av === null || av === undefined) av = '';
        if (bv === null || bv === undefined) bv = '';

        // szám, egyébként string
        if (col === 'id' || col === 'legacy_id') {
            av = Number(av) || 0;
            bv = Number(bv) || 0;
        } else {
            av = String(av);
            bv = String(bv);
        }

        let comp = 0;
        if (typeof av === 'number' && typeof bv === 'number') {
            comp = av - bv;
        } else {
            comp = av.localeCompare(bv, 'hu');
        }

        return sortDirection === 'asc' ? comp : -comp;
    });

    for (const p of sorted) {
        const tr = document.createElement('tr');

        tr.innerHTML = `
            <td>${p.id}</td>
            <td>${p.legacy_id ?? ''}</td>
            <td>${p.name}</td>
            <td>${p.gender ?? ''}</td>
            <td>${formatDate(p.birth_date)}</td>
            <td>${p.nationality ?? ''}</td>
            <td>
                <button class="btn btn-sm btn-outline-warning me-2" data-action="edit" data-id="${p.id}">Szerkesztés</button>
                <button class="btn btn-sm btn-outline-danger" data-action="delete" data-id="${p.id}">Törlés</button>
            </td>
        `;

        tbody.appendChild(tr);
    }

    // fejlécek vizuális jelzése
    document.querySelectorAll('#pilotsTable thead th.sortable').forEach(th => {
        th.classList.remove('text-info');
        const col = th.dataset.column;
        const label = th.dataset.label;
        if (col === sortColumn) {
            th.classList.add('text-info');
            th.innerHTML = label + (sortDirection === 'asc' ? ' ▲' : ' ▼');
        } else {
            th.innerHTML = label;
        }
    });
}

// Új / szerkesztés form submit (CREATE + UPDATE)
document.getElementById('pilotForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const id = editingId;
    const legacy_id = document.getElementById('legacyId').value.trim();
    const name = document.getElementById('name').value.trim();
    const gender = document.getElementById('gender').value;
    const birth_date = document.getElementById('birthDate').value;
    const nationality = document.getElementById('nationality').value.trim();

    if (!name || !gender || !nationality) {
        setFormMessage('Név, nem és állampolgárság kötelező mezők.', true);
        return;
    }

    const body = { legacy_id, name, gender, birth_date, nationality };

    try {
        let res;
        if (id === null) {
            // CREATE
            res = await fetch(API_BASE, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
        } else {
            // UPDATE
            res = await fetch(`${API_BASE}/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
        }

        if (!res.ok) {
            throw new Error('Hibás válasz a szervertől.');
        }

        const saved = await res.json();
        setFormMessage(id === null ? 'Új pilóta sikeresen elmentve.' : 'Pilóta adatai frissítve.');

        // lista frissítése
        const idx = pilots.findIndex(p => p.id === saved.id);
        if (idx === -1) {
            pilots.push(saved);
        } else {
            pilots[idx] = saved;
        }

        renderTable();
        resetForm();

    } catch (err) {
        console.error(err);
        setFormMessage('Hiba mentés közben.', true);
    }
});

// Műveletek: szerkesztés / törlés
document.getElementById('pilotsTbody').addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;
    const id = Number(btn.dataset.id);

    if (action === 'edit') {
        const pilot = pilots.find(p => p.id === id);
        if (!pilot) return;

        editingId = pilot.id;
        document.getElementById('pilotId').value = pilot.id;
        document.getElementById('legacyId').value = pilot.legacy_id ?? '';
        document.getElementById('name').value = pilot.name ?? '';
        document.getElementById('gender').value = pilot.gender ?? '';
        document.getElementById('birthDate').value = formatDate(pilot.birth_date);
        document.getElementById('nationality').value = pilot.nationality ?? '';

        document.getElementById('formTitle').textContent = `Pilóta szerkesztése (ID: ${pilot.id})`;
        document.getElementById('saveButton').textContent = 'Változások mentése';
        document.getElementById('saveButton').classList.remove('btn-success');
        document.getElementById('saveButton').classList.add('btn-warning');
        document.getElementById('cancelEditButton').classList.remove('d-none');
        setFormMessage('');
    }

    if (action === 'delete') {
        if (!confirm('Biztosan törölni szeretné ezt a pilótát?')) {
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
            if (!res.ok) {
                throw new Error('Hibás válasz a szervertől.');
            }

            pilots = pilots.filter(p => p.id !== id);
            renderTable();
            setFormMessage('Pilóta törölve az adatbázisból.');
        } catch (err) {
            console.error(err);
            setFormMessage('Hiba a törlés során.', true);
        }
    }
});

// Rendezés fejlécre kattintva
document.querySelectorAll('#pilotsTable thead th.sortable').forEach(th => {
    th.addEventListener('click', () => {
        const col = th.dataset.column;
        if (col === sortColumn) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = col;
            sortDirection = 'asc';
        }
        renderTable();
    });
});

// Szerkesztés megszakítása
document.getElementById('cancelEditButton').addEventListener('click', () => {
    resetForm();
});

// Űrlap alaphelyzetbe állítása
function resetForm() {
    editingId = null;
    document.getElementById('pilotId').value = '';
    document.getElementById('legacyId').value = '';
    document.getElementById('name').value = '';
    document.getElementById('gender').value = '';
    document.getElementById('birthDate').value = '';
    document.getElementById('nationality').value = '';

    document.getElementById('formTitle').textContent = 'Új pilóta felvitele';
    document.getElementById('saveButton').textContent = 'Új pilóta mentése';
    document.getElementById('saveButton').classList.remove('btn-warning');
    document.getElementById('saveButton').classList.add('btn-success');
    document.getElementById('cancelEditButton').classList.add('d-none');
}

// oldal betöltésekor
loadPilots();

async function frissitNav() {
    try {
      const res = await fetch('/app029/api/auth/me');
      const data = await res.json();

      const show = id => document.getElementById(id)?.classList.remove('d-none');
      const hide = id => document.getElementById(id)?.classList.add('d-none');

      // Alap: mindenki látja a login/regisztrációt, üzenetek/admin/logout rejtve
      show('nav-login');
      show('nav-register');
      hide('nav-logout');
      hide('nav-uzenetek');
      hide('nav-admin');

      if (data.loggedIn) {
        // bejelentkezve: login/regisztráció el, logout + üzenetek meg
        hide('nav-login');
        hide('nav-register');
        show('nav-logout');
        show('nav-uzenetek');

        // ha admin, akkor Admin menü is látszik
        if (data.user && data.user.role === 'admin') {
          show('nav-admin');
        }
      }
    } catch (e) {
      console.error('Nav frissítés hiba:', e);
    }
  }

  document.addEventListener('DOMContentLoaded', frissitNav);
</script>

</body>
</html>
